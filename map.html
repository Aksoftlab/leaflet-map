<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Customer Visit Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }

    #locateButton {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      width: 28px;
      height: 28px;
      background-color: white;
      border: 2px solid #555;
      border-radius: 50%;
      box-shadow: 0px 1px 3px rgba(0,0,0,0.3);
      padding: 2px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #locateButton:hover {
      background-color: #eee;
    }

    #locateButton img {
      width: 16px;
      height: 16px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- üìç Floating Button -->
<div id="locateButton" title="‡§Æ‡•á‡§∞‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§®">
  <img src="https://cdn-icons-png.flaticon.com/512/1161/1161225.png" alt="üìç">
</div>

<script>
  let map = L.map('map').setView([26.85, 80.95], 7);
  let userMarker, userCircle;
  const allMarkers = [];
  let autoCenter = true; // üîÅ ‡§Ø‡§π ‡§ï‡§Ç‡§ü‡•ç‡§∞‡•ã‡§≤ ‡§ï‡§∞‡•á‡§ó‡§æ ‡§ë‡§ü‡•ã-‡§∏‡•á‡§Ç‡§ü‡§∞‡§ø‡§Ç‡§ó

  const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors',
    maxZoom: 19
  });

  const satellite = L.tileLayer('https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=ULnBJoZJgjsLtADu9Z24', {
    attribution: '¬© MapTiler',
    tileSize: 512,
    zoomOffset: -1,
    maxZoom: 20
  });

  const baseLayers = {
    "üõ£ Street View": street,
    "üõ∞ Satellite View": satellite
  };

  L.control.layers(baseLayers).addTo(map);
  street.addTo(map);

  // Marker Icons
  const greenIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41], iconAnchor: [12, 41],
    popupAnchor: [1, -34], shadowSize: [41, 41]
  });

  const redIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41], iconAnchor: [12, 41],
    popupAnchor: [1, -34], shadowSize: [41, 41]
  });

  function addMarker(lat, lng, label, status) {
    const icon = status === 'done' ? greenIcon : redIcon;
    const marker = L.marker([lat, lng], { icon }).addTo(map).bindPopup(`<b>${label}</b>`);
    marker._customLat = lat;
    marker._customLng = lng;
    allMarkers.push(marker);
  }

  function removeMarker(lat, lng) {
    for (let i = allMarkers.length - 1; i >= 0; i--) {
      const m = allMarkers[i];
      if (Number(m._customLat) === Number(lat) && Number(m._customLng) === Number(lng)) {
        map.removeLayer(m);
        allMarkers.splice(i, 1);
        break;
      }
    }
  }

  function removeAllMarkers() {
    allMarkers.forEach(m => map.removeLayer(m));
    allMarkers.length = 0;
  }

  function enableLiveUserLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition((pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const accuracy = pos.coords.accuracy;

        if (userMarker) {
          userMarker.setLatLng([lat, lng]);
        } else {
          userMarker = L.marker([lat, lng]).addTo(map).bindPopup("üìå ‡§Æ‡•á‡§∞‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§®").openPopup();
        }

        if (userCircle) {
          userCircle.setLatLng([lat, lng]);
          userCircle.setRadius(accuracy);
        } else {
          userCircle = L.circle([lat, lng], {
            radius: accuracy, color: 'blue', fillColor: '#30f', fillOpacity: 0.2
          }).addTo(map);
        }

        if (autoCenter) {
          map.setView([lat, lng], 15);
        }

      }, (err) => {
        alert("‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: " + err.message);
      }, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 10000
      });
    } else {
      alert("Geolocation ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§");
    }
  }

  // üëâ ‡§ú‡•à‡§∏‡•á ‡§π‡•Ä user pan ‡§Ø‡§æ zoom ‡§ï‡§∞‡•á‡§ó‡§æ, autoCenter ‡§¨‡§Ç‡§¶
  map.on('movestart', () => {
    autoCenter = false;
  });

  // üìç Button ‚Üí manually recenter ‡§î‡§∞ ‡§´‡§ø‡§∞ ‡§∏‡•á autoCenter ‡§ö‡§æ‡§≤‡•Ç ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à
  document.getElementById("locateButton").addEventListener("click", () => {
    if (userMarker && userMarker.getLatLng()) {
      autoCenter = true;
      map.setView(userMarker.getLatLng(), 15);
      userMarker.openPopup();
    }
  });

  enableLiveUserLocation();

  map.on('click', function (e) {
    const lat = e.latlng.lat.toFixed(6);
    const lng = e.latlng.lng.toFixed(6);

    L.popup()
      .setLatLng(e.latlng)
      .setContent(`üìå ‡§ö‡•Å‡§®‡§æ ‡§ó‡§Ø‡§æ ‡§∏‡•ç‡§•‡§æ‡§®:<br>Lat: ${lat}<br>Lng: ${lng}`)
      .openOn(map);

    if (window.AndroidInterface && window.AndroidInterface.setLatLng) {
      window.AndroidInterface.setLatLng(lat, lng);
    }
  });
</script>

</body>
</html>
